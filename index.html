<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #fce7f3 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .expandable-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .expandable-row:hover {
            background: #f3f4f6;
        }
        
        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .details-row {
            display: none;
            background: #f9fafb;
        }
        
        .details-row.show {
            display: table-row;
        }
        
        .details-content {
            padding: 20px;
        }
        
        .feed-detail-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feed-time {
            font-weight: 600;
            color: #1f2937;
        }
        
        .feed-duration {
            color: #3b82f6;
            font-weight: 600;
        }
        
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            padding: 12px 40px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .nav-btn:not(.active) {
            background: white;
            color: #374151;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .feed-card h2 {
            color: #3b82f6;
        }
        
        .diaper-card h2 {
            color: #ec4899;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-wet {
            background: #eab308;
            color: #1f2937;
        }
        
        .btn-wet:hover {
            background: #ca8a04;
        }
        
        .btn-soiled {
            background: #d97706;
            color: white;
        }
        
        .btn-soiled:hover {
            background: #b45309;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .feed-list, .diaper-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .feed-item, .diaper-item {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feed-item {
            background: #dbeafe;
        }
        
        .diaper-item {
            background: #fce7f3;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-container h2 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .export-btn, .import-btn {
            padding: 10px 20px;
            margin: 5px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .export-btn:hover, .import-btn:hover {
            background: #059669;
        }
        
        .data-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë∂ Baby Tracker</h1>
        <div style="text-align: center; margin-bottom: 20px; color: #6b7280; font-size: 22px; font-weight: 600;">
            <span id="current-time"></span>
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showView('today')">Today</button>
            <button class="nav-btn" onclick="showView('trends')">Trends</button>
            <button class="nav-btn" onclick="showView('settings')">Settings</button>
        </div>
        
        <!-- TODAY VIEW -->
        <div id="today-view" class="view active">
            <div class="grid">
                <!-- FEED TRACKING -->
                <div class="card feed-card">
                    <h2>üçº Feed Tracking</h2>
                    
                    <div class="input-group">
                        <label>Start Time</label>
                        <input type="datetime-local" id="feed-start">
                    </div>
                    
                    <div class="input-group">
                        <label>End Time</label>
                        <input type="datetime-local" id="feed-end">
                    </div>
                    
                    <button class="btn btn-primary" onclick="addFeed()">Add Feed</button>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-number" id="today-feed-count">0</div>
                            <div class="stat-label">feeds today</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="today-avg-duration">0</div>
                            <div class="stat-label">avg minutes</div>
                        </div>
                    </div>
                    
                    <div class="feed-list" id="feed-list"></div>
                </div>
                
                <!-- DIAPER TRACKING -->
                <div class="card diaper-card">
                    <h2>üß∑ Diaper Changes</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-wet" onclick="addDiaper('W')">Wet (W)</button>
                        <button class="btn btn-soiled" onclick="addDiaper('S')">Soiled (S)</button>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-number" style="color: #eab308;" id="today-wet-count">0</div>
                            <div class="stat-label">wet</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: #d97706;" id="today-soiled-count">0</div>
                            <div class="stat-label">soiled</div>
                        </div>
                    </div>
                    
                    <div class="diaper-list" id="diaper-list"></div>
                </div>
            </div>
        </div>
        
        <!-- TRENDS VIEW -->
        <div id="trends-view" class="view">
            <div class="chart-container">
                <h2>Daily Summary</h2>
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Feeds</th>
                            <th>Avg Duration</th>
                            <th>Wet</th>
                            <th>Soiled</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body"></tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="display: inline-block; margin-right: 15px;">Feed Durations by Day</h2>
                        <button id="feed-chart-back-btn" onclick="exitFeedDrilldown()" style="display: none; padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ‚Üê Back to All Days
                        </button>
                    </div>
                    <span id="feed-avg-display" style="font-size: 18px; font-weight: bold; color: #ef4444;">Avg: -- min</span>
                </div>
                <canvas id="feedDurationByDayChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Daily Diaper Changes</h2>
                <canvas id="diaperChart"></canvas>
            </div>
        </div>
        
        <!-- SETTINGS VIEW -->
        <div id="settings-view" class="view">
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <h2>‚öôÔ∏è Settings</h2>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #374151;">Day Start Time</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">
                        Set when each day begins and ends. This affects how feeds and diapers are grouped by day.
                    </p>
                    
                    <div class="input-group">
                        <label>Hour (0-23)</label>
                        <input type="number" id="day-start-hour" min="0" max="23" value="6" 
                               style="width: 100px;" onchange="updateDayStart()">
                    </div>
                    
                    <div class="input-group">
                        <label>Minute (0-59)</label>
                        <input type="number" id="day-start-minute" min="0" max="59" value="41" 
                               style="width: 100px;" onchange="updateDayStart()">
                    </div>
                    
                    <div style="padding: 12px; background: #dbeafe; border-radius: 6px; margin-top: 15px;">
                        <strong>Current Day Start Time:</strong> <span id="current-day-start">06:41 AM</span>
                    </div>
                    
                    <p style="color: #6b7280; margin-top: 10px; font-size: 14px;">
                        <strong>Example:</strong> If set to 6:41 AM, any feed or diaper change before 6:41 AM will count toward the previous day.
                    </p>
                </div>
                
                <div class="data-controls" style="margin-top: 30px;">
                    <button class="export-btn" onclick="exportData()">üì• Export Data</button>
                    <button class="import-btn" onclick="document.getElementById('import-file').click()">üì§ Import Data</button>
                    <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="showClearConfirmation()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üóëÔ∏è Clear All Data
                    </button>
                    
                    <div id="clear-confirmation" style="display: none; margin-top: 15px; padding: 15px; background: #fee; border: 2px solid #ef4444; border-radius: 8px;">
                        <p style="color: #dc2626; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è This will delete ALL feeds and diapers!</p>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 14px;">Consider exporting your data first. This cannot be undone.</p>
                        <button onclick="confirmClearAllData()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                            Yes, Delete Everything
                        </button>
                        <button onclick="cancelClearData()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="data-controls">
        </div>
    </div>

    <script>
        // Data storage
        let feeds = JSON.parse(localStorage.getItem('baby-feeds') || '[]');
        let diapers = JSON.parse(localStorage.getItem('baby-diapers') || '[]');
        
        // Day start time settings
        let DAY_START_HOUR = parseInt(localStorage.getItem('day-start-hour') || '6');
        let DAY_START_MINUTE = parseInt(localStorage.getItem('day-start-minute') || '41');
        
        function updateDayStart() {
            const hour = parseInt(document.getElementById('day-start-hour').value);
            const minute = parseInt(document.getElementById('day-start-minute').value);
            
            if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                DAY_START_HOUR = hour;
                DAY_START_MINUTE = minute;
                
                localStorage.setItem('day-start-hour', hour);
                localStorage.setItem('day-start-minute', minute);
                
                updateDayStartDisplay();
                
                // Refresh all views to reflect the change
                renderToday();
                if (document.getElementById('trends-view').classList.contains('active')) {
                    renderCharts();
                }
            }
        }
        
        function updateDayStartDisplay() {
            const hour12 = DAY_START_HOUR % 12 || 12;
            const ampm = DAY_START_HOUR >= 12 ? 'PM' : 'AM';
            const minuteStr = DAY_START_MINUTE.toString().padStart(2, '0');
            document.getElementById('current-day-start').textContent = 
                `${hour12.toString().padStart(2, '0')}:${minuteStr} ${ampm}`;
        }
        
        function getDayKey(dateInput) {
            // Handle datetime-local format strings (YYYY-MM-DDTHH:mm) or Date objects
            let year, month, day, hour, minute;
            
            console.log('getDayKey called with:', dateInput, typeof dateInput);
            
            if (typeof dateInput === 'string') {
                // Check if it's datetime-local format (YYYY-MM-DDTHH:mm)
                if (dateInput.includes('T')) {
                    const parts = dateInput.split('T');
                    const dateParts = parts[0].split('-');
                    const timeParts = parts[1].split(':');
                    
                    year = parseInt(dateParts[0]);
                    month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                    day = parseInt(dateParts[2]);
                    hour = parseInt(timeParts[0]);
                    minute = parseInt(timeParts[1]);
                    
                    console.log('Parsed datetime-local:', {year, month: month+1, day, hour, minute});
                } else {
                    // ISO string - parse as Date
                    const d = new Date(dateInput);
                    year = d.getFullYear();
                    month = d.getMonth();
                    day = d.getDate();
                    hour = d.getHours();
                    minute = d.getMinutes();
                    
                    console.log('Parsed ISO string as Date:', {year, month: month+1, day, hour, minute});
                }
            } else {
                // Date object
                year = dateInput.getFullYear();
                month = dateInput.getMonth();
                day = dateInput.getDate();
                hour = dateInput.getHours();
                minute = dateInput.getMinutes();
                
                console.log('Parsed Date object:', {year, month: month+1, day, hour, minute});
            }
            
            // Check if this time is before the day boundary
            const timeInMinutes = hour * 60 + minute;
            const boundaryInMinutes = DAY_START_HOUR * 60 + DAY_START_MINUTE;
            
            console.log('Time check:', timeInMinutes, 'vs boundary:', boundaryInMinutes, '(', DAY_START_HOUR + ':' + DAY_START_MINUTE, ')');
            
            // Determine which day this belongs to
            let resultDate;
            if (timeInMinutes < boundaryInMinutes) {
                // Before the boundary - belongs to previous day
                resultDate = new Date(year, month, day - 1);
                console.log('BEFORE boundary - using PREVIOUS day');
            } else {
                // After the boundary - belongs to this day
                resultDate = new Date(year, month, day);
                console.log('AFTER boundary - using SAME day');
            }
            
            // Return in YYYY-MM-DD format
            const resultYear = resultDate.getFullYear();
            const resultMonth = String(resultDate.getMonth() + 1).padStart(2, '0');
            const resultDay = String(resultDate.getDate()).padStart(2, '0');
            
            const result = `${resultYear}-${resultMonth}-${resultDay}`;
            console.log('Final day key result:', result);
            console.log('---');
            
            return result;
        }
        
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewName + '-view').classList.add('active');
            event.target.classList.add('active');
            
            if (viewName === 'trends') {
                renderCharts();
            } else if (viewName === 'settings') {
                // Load current settings into inputs
                document.getElementById('day-start-hour').value = DAY_START_HOUR;
                document.getElementById('day-start-minute').value = DAY_START_MINUTE;
                updateDayStartDisplay();
            }
        }
        
        function addFeed() {
            const start = document.getElementById('feed-start').value;
            const end = document.getElementById('feed-end').value;
            
            if (!start || !end) {
                alert('Please enter both start and end times');
                return;
            }
            
            // Don't use new Date() which can cause timezone issues
            // Store the datetime-local value directly
            const startDate = new Date(start);
            const endDate = new Date(end);
            
            if (endDate <= startDate) {
                alert('End time must be after start time');
                return;
            }
            
            const duration = Math.round((endDate - startDate) / 60000);
            
            // Store as local time string to avoid timezone conversion issues
            const newFeed = {
                id: Date.now(),
                startTime: start,  // Store the raw datetime-local value
                endTime: end,      // Store the raw datetime-local value
                duration
            };
            
            console.log('Adding feed with local times:', newFeed);
            
            feeds.push(newFeed);
            
            feeds.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            localStorage.setItem('baby-feeds', JSON.stringify(feeds));
            
            document.getElementById('feed-start').value = '';
            document.getElementById('feed-end').value = '';
            
            renderToday();
        }
        
        function addDiaper(type) {
            diapers.push({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type
            });
            
            diapers.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            localStorage.setItem('baby-diapers', JSON.stringify(diapers));
            
            renderToday();
        }
        
        function deleteFeed(id) {
            feeds = feeds.filter(f => f.id !== id);
            localStorage.setItem('baby-feeds', JSON.stringify(feeds));
            renderToday();
        }
        
        function deleteDiaper(id) {
            diapers = diapers.filter(d => d.id !== id);
            localStorage.setItem('baby-diapers', JSON.stringify(diapers));
            renderToday();
        }
        
        function renderToday() {
            const today = getDayKey(new Date());
            const todayFeeds = feeds.filter(f => getDayKey(new Date(f.startTime)) === today);
            const todayDiapers = diapers.filter(d => getDayKey(new Date(d.timestamp)) === today);
            
            // Update stats
            document.getElementById('today-feed-count').textContent = todayFeeds.length;
            const avgDuration = todayFeeds.length > 0 
                ? Math.round(todayFeeds.reduce((sum, f) => sum + f.duration, 0) / todayFeeds.length)
                : 0;
            document.getElementById('today-avg-duration').textContent = avgDuration;
            
            const wetCount = todayDiapers.filter(d => d.type === 'W').length;
            const soiledCount = todayDiapers.filter(d => d.type === 'S').length;
            document.getElementById('today-wet-count').textContent = wetCount;
            document.getElementById('today-soiled-count').textContent = soiledCount;
            
            // Render feed list
            const feedList = document.getElementById('feed-list');
            feedList.innerHTML = todayFeeds.map(f => `
                <div class="feed-item">
                    <div>
                        <strong>${formatTime(f.startTime)} - ${formatTime(f.endTime)}</strong><br>
                        <small>Duration: ${f.duration} min</small>
                    </div>
                    <button class="delete-btn" onclick="deleteFeed(${f.id})">Delete</button>
                </div>
            `).join('');
            
            // Render diaper list
            const diaperList = document.getElementById('diaper-list');
            diaperList.innerHTML = todayDiapers.map(d => `
                <div class="diaper-item">
                    <div>
                        <strong style="color: ${d.type === 'W' ? '#eab308' : '#d97706'}">${d.type}</strong>
                        <span style="margin-left: 10px;">${formatTime(d.timestamp)}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteDiaper(${d.id})">Delete</button>
                </div>
            `).join('');
        }
        
        function renderCharts() {
            renderFeedDurationByDayChart();
            renderDiaperChart();
            renderSummaryTable();
        }
        
        // Feed chart drill-down state
        let feedChartDrilledDate = null;
        
        function exitFeedDrilldown() {
            feedChartDrilledDate = null;
            document.getElementById('feed-chart-back-btn').style.display = 'none';
            renderFeedDurationByDayChart();
        }
        
        function renderFeedDurationByDayChart() {
            const ctx = document.getElementById('feedDurationByDayChart');
            if (window.feedDurationByDayChartInstance) window.feedDurationByDayChartInstance.destroy();
            
            // Check if we're in drill-down mode
            if (feedChartDrilledDate) {
                renderFeedDrilldownChart(feedChartDrilledDate);
                return;
            }
            
            // Group feeds by day and create individual labels for each feed
            const feedsByDay = {};
            feeds.forEach(f => {
                const day = getDayKey(new Date(f.startTime));
                if (!feedsByDay[day]) feedsByDay[day] = [];
                feedsByDay[day].push(f);
            });
            
            // Sort days and limit to last 7 days
            const sortedDays = Object.keys(feedsByDay).sort().slice(-7);
            
            // Create color palette for different days
            const dayColors = [
                '#3b82f6', // blue
                '#8b5cf6', // purple
                '#ec4899', // pink
                '#f97316', // orange
                '#10b981', // green
                '#06b6d4', // cyan
                '#f59e0b'  // amber
            ];
            
            // Create labels and data arrays - each feed gets its own x-axis position
            const labels = [];
            const data = [];
            const colors = [];
            const dayPositions = []; // Track where each day's bars are
            const barToDayMap = []; // Map each bar index to its day
            
            let currentIndex = 0;
            sortedDays.forEach((day, dayIndex) => {
                const dayFeeds = feedsByDay[day];
                const dayColor = dayColors[dayIndex % dayColors.length];
                const startIndex = currentIndex;
                
                dayFeeds.forEach((feed, feedIndex) => {
                    labels.push(''); // Empty labels, we'll draw custom ones
                    data.push(feed.duration);
                    colors.push(dayColor);
                    barToDayMap.push(day); // Store which day this bar belongs to
                    currentIndex++;
                });
                
                // Store the center position for this day
                const endIndex = currentIndex - 1;
                const centerPosition = (startIndex + endIndex) / 2;
                dayPositions.push({
                    center: centerPosition,
                    label: formatDateShort(day)
                });
            });
            
            // Calculate moving average (simple average of all feeds)
            const overallAverage = data.length > 0 ? data.reduce((a, b) => a + b, 0) / data.length : 0;
            const avgLine = new Array(data.length).fill(overallAverage);
            
            // Update the average display
            document.getElementById('feed-avg-display').textContent = 
                `Avg: ${Math.round(overallAverage)} min`;
            
            window.feedDurationByDayChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Feed Duration',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c),
                        borderWidth: 1,
                        order: 2
                    }, {
                        label: 'Average',
                        data: avgLine,
                        type: 'line',
                        borderColor: '#ef4444',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: {
                            top: 5,
                            right: 5,
                            bottom: 5,
                            left: 5
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: 'Date',
                                padding: { top: 20 }
                            },
                            ticks: {
                                display: false, // Hide default ticks, we'll draw custom ones
                                padding: 10
                            },
                            grid: {
                                offset: true
                            }
                        },
                        y: { 
                            title: { display: true, text: 'Duration (minutes)' },
                            beginAtZero: true
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const barIndex = elements[0].index;
                            const clickedDay = barToDayMap[barIndex];
                            feedChartDrilledDate = clickedDay;
                            document.getElementById('feed-chart-back-btn').style.display = 'inline-block';
                            renderFeedDurationByDayChart();
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Average') {
                                        return 'Average: ' + Math.round(context.parsed.y) + ' min';
                                    }
                                    return 'Duration: ' + context.parsed.y + ' min';
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'customXAxisLabels',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'top';
                        ctx.fillStyle = '#666';
                        ctx.font = '12px Arial';
                        
                        // Draw centered labels for each day
                        dayPositions.forEach(function(dayPos) {
                            const xPixel = xAxis.getPixelForValue(dayPos.center);
                            const yPixel = yAxis.bottom + 10; // Increased spacing
                            ctx.fillText(dayPos.label, xPixel, yPixel);
                        });
                        
                        ctx.restore();
                    }
                }]
            });
        }
        
        function renderFeedDrilldownChart(selectedDate) {
            const ctx = document.getElementById('feedDurationByDayChart');
            
            // Get feeds for the selected day
            const dayFeeds = feeds
                .filter(f => getDayKey(new Date(f.startTime)) === selectedDate)
                .sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            
            if (dayFeeds.length === 0) {
                exitFeedDrilldown();
                return;
            }
            
            const labels = dayFeeds.map(f => formatTime(f.startTime));
            const data = dayFeeds.map(f => f.duration);
            
            // Calculate average for this day
            const dayAverage = data.reduce((a, b) => a + b, 0) / data.length;
            const avgLine = new Array(data.length).fill(dayAverage);
            
            document.getElementById('feed-avg-display').textContent = 
                `Avg: ${Math.round(dayAverage)} min`;
            
            window.feedDurationByDayChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Feed Duration',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        order: 2
                    }, {
                        label: 'Average',
                        data: avgLine,
                        type: 'line',
                        borderColor: '#ef4444',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: {
                            top: 5,
                            right: 5,
                            bottom: 5,
                            left: 5
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: formatDateShort(selectedDate),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: { 
                            title: { display: true, text: 'Duration (minutes)' },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Average') {
                                        return 'Average: ' + Math.round(context.parsed.y) + ' min';
                                    }
                                    const feed = dayFeeds[context.dataIndex];
                                    return [
                                        'Duration: ' + context.parsed.y + ' min',
                                        'Start: ' + formatTime(feed.startTime),
                                        'End: ' + formatTime(feed.endTime)
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDiaperChart() {
            const ctx = document.getElementById('diaperChart');
            if (window.diaperChartInstance) window.diaperChartInstance.destroy();
            
            const dailyStats = getDailyStats();
            const last7Days = dailyStats.slice(-7);
            
            window.diaperChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days.map(d => formatDateShort(d.date)),
                    datasets: [
                        {
                            label: 'Wet',
                            data: last7Days.map(d => d.wet),
                            backgroundColor: '#eab308'
                        },
                        {
                            label: 'Soiled',
                            data: last7Days.map(d => d.soiled),
                            backgroundColor: '#d97706'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: {
                            top: 5,
                            right: 5,
                            bottom: 10,
                            left: 5
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Day' }
                        },
                        y: { 
                            title: { display: true, text: 'Count' },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                },
                plugins: [{
                    id: 'textInDiaperBars',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach(function(dataset, i) {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach(function(bar, index) {
                                const data = dataset.data[index];
                                if (data > 0) {
                                    // Get bar height
                                    const barHeight = Math.abs(bar.height);
                                    
                                    // Choose text color based on background
                                    // Yellow bars (#eab308) need black text
                                    // Brown bars (#d97706) need white text
                                    const bgColor = dataset.backgroundColor;
                                    const useWhiteText = bgColor === '#d97706' || barHeight < 30;
                                    ctx.fillStyle = useWhiteText ? '#ffffff' : '#000000';
                                    
                                    // Adjust font size based on bar height
                                    let fontSize = 14;
                                    if (barHeight < 25) fontSize = 10;
                                    else if (barHeight < 35) fontSize = 12;
                                    
                                    ctx.font = `bold ${fontSize}px Arial`;
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    const x = bar.x;
                                    const y = bar.y + (bar.height / 2);
                                    ctx.fillText(data, x, y);
                                }
                            });
                        });
                    }
                }]
            });
        }
        
        function formatDateShort(dateString) {
            // Convert YYYY-MM-DD to MM-DD
            if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = dateString.split('-');
                return parts[1] + '-' + parts[2]; // MM-DD
            }
            return dateString;
        }
        
        function renderSummaryTable() {
            const dailyStats = getDailyStats();
            const tbody = document.getElementById('summary-body');
            
            console.log('=== renderSummaryTable ===');
            console.log('dailyStats:', dailyStats);
            
            // Limit to last 7 days
            const last7Days = dailyStats.slice(-7).reverse();
            
            console.log('last7Days:', last7Days);
            
            tbody.innerHTML = last7Days.map((day, index) => {
                // Use MM-DD format
                const displayDate = formatDateShort(day.date);
                console.log('Rendering day:', day.date, 'displaying as:', displayDate);
                
                const rowId = 'row-' + index;
                const detailsId = 'details-' + index;
                
                // Get feeds for this day
                const dayFeeds = feeds.filter(f => {
                    const feedDay = getDayKey(new Date(f.startTime));
                    console.log('  Feed:', f.startTime, '-> dayKey:', feedDay, 'matches?', feedDay === day.date);
                    return feedDay === day.date;
                }).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
                
                const hasFeeds = dayFeeds.length > 0;
                
                return `
                    <tr class="expandable-row" onclick="toggleRow('${detailsId}', '${rowId}')" id="${rowId}">
                        <td>
                            ${hasFeeds ? '<span class="expand-icon" id="icon-' + rowId + '">‚ñ∂</span>' : ''}
                            ${displayDate}
                        </td>
                        <td>${day.feedCount}</td>
                        <td>${day.avgDuration} min</td>
                        <td>${day.wet}</td>
                        <td>${day.soiled}</td>
                    </tr>
                    ${hasFeeds ? `
                    <tr class="details-row" id="${detailsId}">
                        <td colspan="5">
                            <div class="details-content">
                                <h3 style="margin-bottom: 12px; color: #1f2937;">Feed Details for ${displayDate}</h3>
                                ${dayFeeds.map((feed, i) => `
                                    <div class="feed-detail-item">
                                        <div>
                                            <span class="feed-time">Feed ${i + 1}: ${formatTime(feed.startTime)} - ${formatTime(feed.endTime)}</span>
                                        </div>
                                        <div class="feed-duration">${feed.duration} minutes</div>
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                    ` : ''}
                `;
            }).join('');
        }
        
        function toggleRow(detailsId, rowId) {
            const detailsRow = document.getElementById(detailsId);
            const icon = document.getElementById('icon-' + rowId);
            
            if (detailsRow) {
                detailsRow.classList.toggle('show');
                if (icon) {
                    icon.classList.toggle('expanded');
                }
            }
        }
        
        function getDailyStats() {
            const stats = {};
            
            feeds.forEach(f => {
                const day = getDayKey(new Date(f.startTime));
                if (!stats[day]) stats[day] = { feedCount: 0, totalDuration: 0, wet: 0, soiled: 0 };
                stats[day].feedCount++;
                stats[day].totalDuration += f.duration;
            });
            
            diapers.forEach(d => {
                const day = getDayKey(new Date(d.timestamp));
                if (!stats[day]) stats[day] = { feedCount: 0, totalDuration: 0, wet: 0, soiled: 0 };
                if (d.type === 'W') stats[day].wet++;
                if (d.type === 'S') stats[day].soiled++;
            });
            
            return Object.entries(stats)
                .map(([date, data]) => ({
                    date,
                    feedCount: data.feedCount,
                    avgDuration: data.feedCount > 0 ? Math.round(data.totalDuration / data.feedCount) : 0,
                    wet: data.wet,
                    soiled: data.soiled
                }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
        
        function exportData() {
            const data = {
                feeds: feeds,
                diapers: diapers,
                dayStartHour: DAY_START_HOUR,
                dayStartMinute: DAY_START_MINUTE,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `baby-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    feeds = data.feeds || [];
                    diapers = data.diapers || [];
                    
                    // Import day start settings if present
                    if (data.dayStartHour !== undefined) {
                        DAY_START_HOUR = data.dayStartHour;
                        localStorage.setItem('day-start-hour', DAY_START_HOUR);
                    }
                    if (data.dayStartMinute !== undefined) {
                        DAY_START_MINUTE = data.dayStartMinute;
                        localStorage.setItem('day-start-minute', DAY_START_MINUTE);
                    }
                    
                    localStorage.setItem('baby-feeds', JSON.stringify(feeds));
                    localStorage.setItem('baby-diapers', JSON.stringify(diapers));
                    
                    renderToday();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Error importing data: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL feeds and diaper data? This cannot be undone!')) {
                if (confirm('Really delete everything? Consider exporting first!')) {
                    feeds = [];
                    diapers = [];
                    localStorage.setItem('baby-feeds', JSON.stringify(feeds));
                    localStorage.setItem('baby-diapers', JSON.stringify(diapers));
                    renderToday();
                    alert('All data cleared!');
                    console.log('All data has been cleared');
                }
            }
        }
        
        function showClearConfirmation() {
            document.getElementById('clear-confirmation').style.display = 'block';
        }
        
        function cancelClearData() {
            document.getElementById('clear-confirmation').style.display = 'none';
        }
        
        function confirmClearAllData() {
            feeds = [];
            diapers = [];
            localStorage.setItem('baby-feeds', JSON.stringify(feeds));
            localStorage.setItem('baby-diapers', JSON.stringify(diapers));
            renderToday();
            document.getElementById('clear-confirmation').style.display = 'none';
            console.log('All data has been cleared');
            
            // Show a success message
            alert('All data cleared successfully!');
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            document.getElementById('current-time').textContent = timeString;
        }
        
        // Initialize on load
        updateCurrentTime();
        renderToday();
        updateDayStartDisplay();
        
        // Update time every second
        setInterval(updateCurrentTime, 1000);
    </script>
</body>
</html>
